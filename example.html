<!DOCTYPE html>
<html>
<head>
  <title>Leaflet.Canvas example</title>
  <!-- based on leaflet quick example: http://leafletjs.com/examples/quick-start-example.html -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
  <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
  <![endif]-->

  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

  <style> 
    html, body, #map { height: 100%; padding: 0; margin: 0;}
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
  <script src="leaflet_canvas_layer.js"></script>
  <script>

    var map = L.map('map').setView(
      [38, -120],
      5
    );

    L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery <a href="http://stamen.com">Stamen</a>'
    }).addTo(map);

    L.tileLayer('http://tile3.aerisapi.com/wgE96YE3scTQLKjnqiMsv_DGCTq4z2xxttTBwTiimwlWyxmx5IDwK0VZ7T2WMS/sat/{z}/{x}/{y}/0.png', {
      maxZoom: 18
    }).addTo(map);



    var BigPointLayer = L.CanvasLayer.extend({

      initialize: function(latLon, radius, color) {
        this.latLon = latLon;
        this.radius = radius;
        this.color = color;
        L.CanvasLayer.prototype.initialize.call(this);
      },

      renderCircle: function(ctx, point, radius) {
        ctx.fillStyle = 'rgba(255, 60, 60, 0.2)';
        ctx.strokeStyle = this.color;
        ctx.beginPath();
        ctx.arc(point.x, point.y, radius, 0, Math.PI * 2.0, true, true);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
      },

      render: function() {
        var canvas = this.getCanvas();
        var ctx = canvas.getContext('2d');

        // clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // get center from the map (projected)
        var point = this._map.latLngToContainerPoint(this.latLon);

        // render
        this.renderCircle(ctx, point, (1.0 + Math.sin(Date.now()*0.005)) * this.radius);

        this.redraw();

      }
    });

    var clientId = getQueryParam('client_id');
    var clientSecret = getQueryParam('client_secret');
    var earthquakesUrl = 'http://api.aerisapi.com/earthquakes/within?' +
            'p=:auto&' +
            'client_id=' + clientId  + '&' +
            'client_secret=' + clientSecret + '&' +
            'limit=10&' +
            'radius=3000mi&' +
            'from=-8weeks';

    $.getJSON(earthquakesUrl).
      done(function(res) {
          res.response.forEach(drawEarthquake);
      }).
      fail(function(err) {
        console.log('API error: ', err);
      });


    function drawEarthquake(earthquake) {
      var pointView;
      var latLon = new L.LatLng(earthquake.loc.lat, earthquake.loc.long);
      var mag = earthquake.report.mag;
      var radius = Math.pow(mag * 1.75, 2);
      var color;

      if (mag < 1) {
        color = '#0000ff';
      }
      else if (mag < 2) {
        color = '#00ff00';
      }
      else {
        color = '#ff0000';
      }

      pointView = new BigPointLayer(latLon, radius, color);
      pointView.addTo(map);

    }


    function getQueryParam(name) {
      name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec(location.search);
      return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }

  </script>
</body>
</html>
